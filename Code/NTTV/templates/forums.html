<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='components/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='components/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='forum.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTTV ‚Äì –¢–µ–º–∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Staatliches:wght@400&family=JetBrains+Mono:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
  {% include "components/header.jinja" %}

  <main class="main-layout">
      <div class="sidebar">
          <div class="card create-forum-card">
              {% if 'user_id' in session %}
                  <section class="create-forum">
                      <h2>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ–º</h2>
                      <form action="{{ url_for('forums') }}" method="POST">
                          <label for="forum_name">–ù–∞–∑–≤–∞ –¢–µ–º–∏:</label>
                          <input type="text" id="forum_name" name="forum_name" required />
                          <label for="forum_description">–û–ø–∏—Å –¢–µ–º–∏:</label>
                          <input type="text" id="forum_description" name="forum_description" required />
                          <button type="submit" class="fix_btn">–°—Ç–≤–æ—Ä–∏—Ç–∏ –¢–µ–º–∏</button>
                      </form>
                  </section>
                  <p class="subtitle_s">–≤–∞–≥–∞—î—Ç–µ—Å—è —á–∏ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç–µ–º—É? —á–∏ —î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è? –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—è –¥–æ –Ω–∞—à–æ–≥–æ :</p>
                  <p class="subtitle"><a href="https://docs.google.com/document/d/1D3_-t8Nhd7-MKiRnXctxgexI1nBVyEr6cAERzAXqoIg/edit?usp=sharing">–î–æ–∫—É–º–µ–Ω—Ç—É</a></p>
              {% else %}
                  <p>–î–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¢–µ–º–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ <a href="{{ url_for('login') }}">—É–≤—ñ–π—Ç–∏</a>.</p>
              {% endif %}
          </div>

          <div class="card live-forums">
              <h2>–¢–µ–º–∏ - –í –µ—Ç–µ—Ä—ñ</h2>
              <p class="subtitle_s">–°–≤—ñ—Ç–∏ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è –Ω–∞–∂–∏–≤–æ —á–µ–∫–∞—é—Ç—å –Ω–∞ –≤–∞—Å!</p>
              <ul>
                  {% for forum_id, forum in forums if forum.is_live %}
                  <li>
                      <a href="{{ url_for('view_forum', forum_id=forum_id) }}">
                          {{ forum['name'] }}
                      </a>
                  </li>
                  {% endfor %}
              </ul>
          </div>
      </div>

      <section class="forum-list card">
          <h2 class="red-title">–¢–µ–º–∏</h2>
          <h3 class="subtitle_s">—Ç—É—Ç —Å–æ—Ç–Ω—ñ —Ç–∏—Å—è—á –º–∞–ª–µ–Ω—å–∫–∏—Ö —Å–≤—ñ—Ç—ñ–≤ —è–∫—ñ —Ö–æ—á—É—Ç—å, —â–æ–± –≤–∏ —ó—Ö –¥–æ—Å–ª—ñ–¥–∏–ª–∏...</h3>
          <ul>
              {% for forum_id, forum in forums %}
              <li class="post">
                  <div class="post-content">
                      <h3>{{ forum['name'] }}</h3>
                      <h4 class="live">{% if forum.is_live %}/ –í –µ—Ç–µ—Ä—ñ {% endif %}</h4>
                      <h4 class="subtitle_s">–ø—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: {{ get_subscriber_count(forum_id) }}</h4>
                      <h5 class="subtitle">–†–µ–ø: {{ forum['reputation'] }}</h5>
                      <p>{{ forum['description'[:50]] | safe }}</p>
                      <div class="author">
                            –ê–≤—Ç–æ—Ä:
                      {% set author = users.get(forum['author_id']) %}
                      {% if author %}
                          <a href="{{ url_for('view_user_profile', uid=forum['author_id']) }}">
                      {{ author['username'] }}
                      </a>
                      {% else %}
                          ???
                      {% endif %}
                      </div>

                      <a href="{{ url_for('view_forum', forum_id=forum_id) }}">üîç –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</a>
                  </div>

                  {% if show_menu == forum_id %}
                  <div class="admin-menu">
                      {% if session['user_id'] == forum['author_id'] or 'admin' in session.get('roles', []) %}
                          <form action="{{ url_for('delete_forum', forum_id=forum_id) }}" method="POST" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ç–µ–º—É?')">
                              <button type="submit" class="delete-btn">–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–º—É</button>
                          </form>
                          <form action="{{ url_for('edit_forum', forum_id=forum_id) }}" method="GET">
                              <button type="submit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                          </form>
                      {% endif %}
                  </div>
                  {% endif %}

                  <div class="votes">
                      <form action="{{ url_for('vote_forum', forum_id=forum_id) }}" method="POST">
                          {% if session['user_id'] not in forum['votes'] %}
                              <button type="submit" name="vote" value="up">‚¨ÜÔ∏è</button>
                              <span>{{ forum['vote_count'] }}</span>
                              <button type="submit" name="vote" value="down">‚¨áÔ∏è</button>
                          {% else %}
                              <button type="submit" name="vote" value="cancel">‚ùå</button>
                          {% endif %}
                      </form>
                  </div>
                  
                  {% if 'user_id' in session %}
                      {% if session['user_id'] not in forum['subscribers'] %}
                          <form action="{{ url_for('subscribe_forum', forum_id=forum_id) }}" method="POST">
                              <button type="submit">–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è</button>
                          </form>
                      {% else %}
                          <form action="{{ url_for('unsubscribe_forum', forum_id=forum_id) }}" method="POST">
                              <button type="submit">–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è</button>
                          </form>
                      {% endif %}
                      {% if session['user_id'] == forum['author_id'] %}
                          <form action="{{ url_for('moderate_forum', forum_id=forum_id) }}" method="GET">
                              <button type="submit">–∫–µ—Ä—É–≤–∞—Ç–∏</button>
                          </form>
                      {% endif %}
                  {% else %}
                      <p>–î–ª—è –ø—ñ–¥–ø–∏—Å–∫–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ <a href="{{ url_for('login') }}">—É–≤—ñ–π—Ç–∏</a>.</p>
                  {% endif %}
              </li>
              {% endfor %}
          </ul>
      </section>
  </main>

  {% include "components/footer.jinja" %}

  <script>
  setInterval(() => {
    fetch(location.href, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(res => res.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        const newList = doc.querySelector('.forum-list');
        const oldList = document.querySelector('.forum-list');
        if (newList && oldList) {
          oldList.innerHTML = newList.innerHTML;
        }

        const newLiveSidebar = doc.querySelector('.live-forums ul');
        const oldLiveSidebar = document.querySelector('.live-forums ul');
        if (newLiveSidebar && oldLiveSidebar) {
          oldLiveSidebar.innerHTML = newLiveSidebar.innerHTML;
        }
      })
      .catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:", err));
  }, 30000); 
  </script>
</body>
</html>